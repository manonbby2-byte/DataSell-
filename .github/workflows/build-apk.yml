name: Cordova Android Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: 'wrapper'  # Checkout into wrapper directory
    
    - name: Setup Java 17 (required for Android SDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'wrapper/package.json'
    
    - name: Install Cordova CLI
      run: |
        npm install -g cordova
    
    - name: Change to wrapper directory
      run: |
        cd wrapper
        pwd
        ls -la
    
    - name: Install Android SDK (manual setup)
      run: |
        # Create Android SDK directory
        mkdir -p /usr/local/lib/android/sdk
        
        # Download and extract Android Command Line Tools
        # Using version 9.0 which is compatible with Java 11
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        mkdir -p /usr/local/lib/android/sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d /usr/local/lib/android/sdk/cmdline-tools
        mv /usr/local/lib/android/sdk/cmdline-tools/cmdline-tools /usr/local/lib/android/sdk/cmdline-tools/latest
        
        # Set environment variables
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/lib/android/sdk/cmdline-tools/latest/bin:/usr/local/lib/android/sdk/platform-tools:$PATH" >> $GITHUB_ENV
        
        # Verify installation
        ls -la /usr/local/lib/android/sdk/cmdline-tools/latest/bin/
    
    - name: Accept Android licenses
      run: |
        yes | sdkmanager --licenses || true
    
    - name: Install Android build tools
      run: |
        # Install required packages (Android 13/API 33 is required for Cordova Android 14)
        sdkmanager "platform-tools"
        sdkmanager "platforms;android-33"
        sdkmanager "build-tools;33.0.0"
        sdkmanager "platforms;android-34"
        sdkmanager "build-tools;34.0.0"
    
    - name: Install project dependencies
      run: |
        cd wrapper
        npm install
        # Initialize Cordova project if not already initialized
        if [ ! -d "platforms" ]; then
          echo "Initializing Cordova project..."
          # Check if config.xml exists (it should from your repo)
          if [ -f "config.xml" ]; then
            # Create a minimal package.json if missing
            if [ ! -f "package.json" ]; then
              cat > package.json << EOF
              {
                "name": "com.datasell.app",
                "version": "1.0.0",
                "description": "DataSell App",
                "main": "index.js",
                "scripts": {
                  "test": "echo \"Error: no test specified\" && exit 1"
                },
                "author": "",
                "license": "ISC"
              }
              EOF
            fi
            # Add android platform
            cordova platform add android@14.0.1
          else
            echo "Error: config.xml not found in wrapper directory"
            exit 1
          fi
        fi
    
    - name: Install ImageMagick for logo processing
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
    
    - name: Copy logo and bundle public folder
      run: |
        cd wrapper
        
        # Create images directory
        mkdir -p www/images
        
        # Copy logo from parent directory (matching your build script)
        if [ -f "../public/images/web-logo2.png" ]; then
          cp "../public/images/web-logo2.png" "www/images/web-logo2.png"
          echo "‚úì Copied web-logo2.png"
        elif [ -f "../../public/images/web-logo2.png" ]; then
          cp "../../public/images/web-logo2.png" "www/images/web-logo2.png"
          echo "‚úì Copied web-logo2.png from parent directory"
        else
          echo "‚ö† Warning: Logo not found, using placeholder"
          # Create a simple placeholder using ImageMagick
          convert -size 1024x1024 xc:#4A90E2 -pointsize 100 -fill white -gravity center -draw "text 0,0 'DS'" www/images/web-logo2.png 2>/dev/null || echo "Placeholder creation failed - continuing without custom logo"
        fi
        
        # Copy public folder into www/app (matching your build script)
        if [ -d "../public" ]; then
          echo "Copying public folder to www/app..."
          rm -rf www/app
          mkdir -p www/app
          cp -r ../public/. www/app/
          echo "‚úì Public folder copied"
        elif [ -d "../../public" ]; then
          echo "Copying public folder from parent directory..."
          rm -rf www/app
          mkdir -p www/app
          cp -r ../../public/. www/app/
          echo "‚úì Public folder copied"
        fi
        
        # Create necessary directories to avoid errors
        mkdir -p www/app/downloads
        mkdir -p platforms/android/app/build/outputs/apk/
    
    - name: Build Debug APK
      run: |
        cd wrapper
        cordova build android --debug \
          -- --no-daemon \
          -Dorg.gradle.jvmargs="-Xmx1200m -Dfile.encoding=UTF-8"
        echo "Debug APK built"
    
    - name: Copy debug APK for distribution
      run: |
        cd wrapper
        mkdir -p dist/debug
        APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
        
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" "dist/debug/datasell-debug.apk"
          echo "Debug APK copied to dist/debug/"
          
          # Get APK info
          APK_SIZE=$(stat -c%s "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
          echo "Debug APK size: ${APK_SIZE_MB} MB"
          echo "debug_apk_size_mb=${APK_SIZE_MB}" >> $GITHUB_ENV
          
          # Copy APK to root directory for easier access
          mkdir -p ../../dist/debug
          cp "$APK_PATH" "../../dist/debug/datasell-debug.apk"
        else
          echo "‚ùå Debug APK not found at: $APK_PATH"
          echo "Checking directory contents:"
          find platforms/android/app/build/outputs/ -name "*.apk" 2>/dev/null || true
        fi
    
    - name: Prepare keystore for signing
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      run: |
        cd wrapper
        if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
          echo "üîê Setting up keystore for release signing..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android-release.keystore
          
          # Create keystore properties file from secrets
          cat > keystore.properties << EOF
          storeFile=android-release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
          
          echo "‚úì Keystore setup complete"
        else
          echo "‚ö† No keystore secret found. Release builds will be unsigned."
        fi
    
    - name: Build Release APK
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      run: |
        cd wrapper
        if [ -f "keystore.properties" ]; then
          echo "üî® Building release APK with signing..."
          cordova build android --release \
            -- --no-daemon \
            -Dorg.gradle.jvmargs="-Xmx1200m -Dfile.encoding=UTF-8"
          
          RELEASE_APK="platforms/android/app/build/outputs/apk/release/app-release.apk"
          SIGNED_APK="dist/release/datasell-release-${{ github.sha }}.apk"
          
          if [ -f "$RELEASE_APK" ]; then
            echo "‚úì Release APK built successfully"
            
            # Create dist directory
            mkdir -p dist/release
            
            # Sign the APK
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore android-release.keystore \
              -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
              -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
              "$RELEASE_APK" "${{ secrets.ANDROID_KEY_ALIAS }}"
            
            # Align with zipalign
            $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -v 4 "$RELEASE_APK" "$SIGNED_APK"
            
            # Verify alignment
            $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -c 4 "$SIGNED_APK"
            
            echo "‚úì APK signed and aligned"
            
            # Get APK info
            APK_SIZE=$(stat -c%s "$SIGNED_APK")
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
            echo "release_apk_size_mb=${APK_SIZE_MB}" >> $GITHUB_ENV
            
            # Copy APK to root directory for easier access
            mkdir -p ../../dist/release
            cp "$SIGNED_APK" "../../dist/release/datasell-release-${{ github.sha }}.apk"
            
          else
            echo "‚ùå Release APK not found at: $RELEASE_APK"
            echo "Checking directory contents:"
            find platforms/android/app/build/outputs/ -name "*.apk" 2>/dev/null || true
            exit 1
          fi
        else
          echo "‚ö† Skipping release build (no keystore)"
        fi
    
    - name: Upload debug APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: dist/debug/
        if-no-files-found: error
    
    - name: Upload release APK as artifact
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: dist/release/
        if-no-files-found: ignore
    
    - name: Extract version info from config.xml
      id: version-info
      run: |
        cd wrapper
        VERSION=$(grep -o 'version="[^"]*"' config.xml | head -1 | sed 's/version="//;s/"//' || echo "1.0.0")
        APP_NAME=$(grep -o '<name>[^<]*</name>' config.xml | head -1 | sed 's/<name>//;s/<\/name>//' || echo "DataSellApp")
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "tag_name=v${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "release_name=${APP_NAME} v${VERSION} (${SHORT_SHA})" >> $GITHUB_OUTPUT
    
    - name: Generate release notes
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      id: release-notes
      run: |
        # Get latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          CHANGES="Initial release"
        else
          # Get commits since last tag
          CHANGES=$(git log --pretty=format:"- %s (%h)" "${LATEST_TAG}"..HEAD --no-merges)
          if [ -z "$CHANGES" ]; then
            CHANGES="No significant changes"
          fi
        fi
        
        # Create release body
        RELEASE_BODY=$(cat << EOF
        ### üöÄ What's New
        
        ${CHANGES}
        
        ### üì± Build Details
        - **App**: ${{ steps.version-info.outputs.app_name }}
        - **Version**: ${{ steps.version-info.outputs.version }}
        - **Build**: ${{ steps.version-info.outputs.short_sha }}
        - **Date**: ${{ steps.version-info.outputs.build_date }}
        - **Cordova**: $(cd wrapper && cordova --version)
        - **Android SDK**: 34
        
        ### üì¶ APK Downloads
        - **Release APK**: Signed and aligned for Google Play
        - **Debug APK**: For testing only
        
        ### üîê Security
        - APK is signed with release keystore
        - SHA-256 with RSA signing
        - Zipalign optimized
        
        ---
        
        *Built automatically with GitHub Actions*
        EOF
        )
        
        # Save to file for GitHub Actions
        echo "$RELEASE_BODY" > release_body.md
    
    - name: Create GitHub Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version-info.outputs.tag_name }}
        name: ${{ steps.version-info.outputs.release_name }}
        body_path: release_body.md
        prerelease: false
        draft: false
        files: |
          dist/release/*.apk
          dist/debug/*.apk
        generate_release_notes: false
    
    - name: Tagged Release (for version tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: ${{ steps.version-info.outputs.app_name }} ${{ github.ref_name }}
        body: |
          ### üè∑Ô∏è Tagged Release: ${{ github.ref_name }}
          
          **Version**: ${{ steps.version-info.outputs.version }}
          **Commit**: ${{ steps.version-info.outputs.short_sha }}
          **Build Date**: ${{ steps.version-info.outputs.build_date }}
          
          ### üì¶ APK Downloads
          - Release APK: Signed and ready for distribution
          - Debug APK: For testing purposes
          
          ---
          *Production release built with GitHub Actions*
        files: |
          dist/release/*.apk
          dist/debug/*.apk
