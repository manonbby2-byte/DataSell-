name: Build Cordova Android Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '18'
      JAVA_VERSION: '11'
      ANDROID_API_LEVEL: '33'
      ANDROID_BUILD_TOOLS: '33.0.2'
      # Keystore secret (optional): base64 encoded keystore file
      # ANDROID_KEYSTORE_BASE64 - (repo secret) base64 contents of keystore
      # ANDROID_KEYSTORE_PASSWORD - (repo secret) keystore password
      # ANDROID_KEY_ALIAS - (repo secret) key alias
      # ANDROID_KEY_PASSWORD - (repo secret) key password

    steps:
      - name: Ensure tar is available
        run: |
          if ! command -v tar >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y tar
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install system packages
        run: sudo apt-get update && sudo apt-get install -y unzip zip wget curl

      - name: Prepare Android SDK cmdline-tools and install platform/build-tools
        id: android-sdk
        run: |
          # Use a local Android SDK installed into the runner temp directory to avoid needing system SDK
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

          # If sdkmanager already exists on runner, use it, otherwise download commandline tools
          if ! command -v sdkmanager >/dev/null 2>&1; then
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
            # Download command-line tools (versioned filename may change - this URL works for many runners)
            curl -fsSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o /tmp/cmdline-tools.zip
            unzip -q /tmp/cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
            # The zip unpacks into a folder named "cmdline-tools"; move to "latest" for sdkmanager path
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/"* "$ANDROID_SDK_ROOT/cmdline-tools/latest/" || true
            export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          fi

          export ANDROID_SDK_ROOT="$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          echo "PATH=$PATH" >> $GITHUB_ENV

          # Accept licenses and install required components
          # sdkmanager can be quieted; retry a few times to avoid transient network issues
          retry() { for i in 1 2 3; do "$@" && break || sleep 5; done }
          retry sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses < /dev/null || true
          retry sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}"

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install project dependencies
        run: npm ci

      - name: Install Cordova CLI
        run: |
          npm install -g cordova@11 || true
          cordova --version

      - name: Add Android platform (if missing)
        run: |
          # Only add if not present (prevents repeated changes)
          if ! npx cordova platform ls | grep -q "android"; then
            npx cordova platform add android@"~11.0.0" || true
          fi

      - name: Restore keystore (optional)
        if: secrets.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          echo "Restoring keystore from ANDROID_KEYSTORE_BASE64 secret"
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ./release.keystore
          chmod 600 ./release.keystore

      - name: Create gradle signing properties (if keystore present)
        run: |
          # If we have the keystore and signing secrets, write gradle properties so Cordova/Gradle picks them up
          if [ -f ./release.keystore ]; then
            mkdir -p "$HOME/.gradle"
            cat >> "$HOME/.gradle/gradle.properties" <<EOF
RELEASE_STORE_FILE=${PWD}/release.keystore
RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
EOF
            echo "Wrote $HOME/.gradle/gradle.properties"
          else
            echo "No keystore found; building unsigned release APK."
          fi

      - name: Build Cordova Android (release)
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
        run: |
          # Clean old builds
          npx cordova clean android || true

          # Build release APK. If signing properties exist, Gradle will sign the APK.
          npx cordova build android --release -- --no-daemon

      - name: Locate produced APK(s)
        id: find-apks
        run: |
          # Find apk(s) produced by the current cordova-android layout (app folder for recent versions)
          APKS=$(find ./platforms/android -type f -name "*.apk" -print)
          echo "apks<<EOF" >> $GITHUB_OUTPUT
          echo "$APKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found APKs:"
          echo "$APKS"

      - name: Upload APK artifact(s)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find-apks.outputs.apks }}
